<script>
  // ... (previous constants and variable declarations remain unchanged)

  const FEEDBACK_DURATION = 240; // 4 seconds at 60 FPS (4 * 60)

  // ... (preloadImages, resizeCanvas, shuffle, initGame, initLearn remain unchanged)

  function drawGame() {
    if (!isGameActive || mode !== "game") {
      if (animationFrameId) cancelAnimationFrame(animationFrameId);
      return;
    }
    const width = canvas.width / scaleFactor;
    const height = canvas.height / scaleFactor;
    ctx.clearRect(0, 0, width, height);

    // ... (rest of drawGame remains unchanged until feedbackTimer logic)

    if (feedbackTimer > 0) {
      const isCorrectAnswer = selectedAnswer === currentQuestion.answer;
      ctx.fillStyle = isCorrectAnswer ? "rgba(76, 175, 80, 0.8)" : "rgba(244, 67, 54, 0.9)";
      const overlayHeight = 3 * (buttonHeight + buttonSpacing);
      ctx.fillRect(10, buttonYStart, width - 20, overlayHeight);

      const iconSize = height * 0.09;
      const iconX = width - 20 - iconSize - 15;
      const iconY = buttonYStart + overlayHeight - iconSize - 15;
      const icon = imageCache["https://lqy3lriiybxcejon.public.blob.vercel-storage.com/BlYgTSuLAG9w/sticker-uhB1G0rlyrpomrlXxFVTt8KLT4aGTU.webp?SGHY"];
      if (icon && icon.complete) ctx.drawImage(icon, iconX, iconY, iconSize, iconSize);

      ctx.fillStyle = "#fff";
      ctx.font = `${Math.min(Math.max(height * 0.03, 16), 24)}px 'Poppins'`;
      ctx.fillText(currentQuestion.answer || "უცნობი", width / 2, buttonYStart + height * 0.05);

      ctx.font = `${Math.min(Math.max(height * 0.025, 14), 22)}px 'Poppins'`;
      wrapText(ctx, currentQuestion.description || "აღწერა არ არის ხელმისაწვდომი", width / 2, buttonYStart + overlayHeight / 2, width - 40, height * 0.03);
      feedbackTimer--; // Decrement each frame
    }

    // ... (rest of drawGame remains unchanged)

    animationFrameId = requestAnimationFrame(drawGame);
  }

  // ... (drawLearn, wrapText, calculateScore, endGame, endLearn, returnToHome remain unchanged)

  function handleInteraction(x, y) {
    if (!isGameActive) return;
    const width = canvas.width / scaleFactor;
    const height = canvas.height / scaleFactor;

    // Home button interaction
    const homeButtonSize = Math.min(height * 0.06, 40);
    if (x >= width - homeButtonSize - 10 && x <= width - 10 && y >= 10 && y <= 10 + homeButtonSize) {
      returnToHome();
      return;
    }

    if (mode === "game" && feedbackTimer === 0) { // Only allow answer selection when feedbackTimer is 0
      const buttonHeight = Math.min(Math.max(height * 0.08, 40), 70);
      const buttonSpacing = height * 0.03;
      const buttonYStart = height * 0.33 + height * 0.2;
      const options = quizQuestions[currentRound]?.options || [];
      options.forEach((option, idx) => {
        const buttonY = buttonYStart + idx * (buttonHeight + buttonSpacing);
        if (x >= 20 && x <= width - 20 && y >= buttonY && y <= buttonY + buttonHeight) {
          handleAnswer(option);
        }
      });
    } else if (mode === "learn") {
      // ... (learn mode interaction logic remains unchanged)
    }
  }

  // ... (event listeners remain unchanged)

  function handleAnswer(option) {
    if (feedbackTimer > 0) return;
    const currentQuestion = quizQuestions[currentRound] || {};
    selectedAnswer = option;
    const points = calculateScore(option, currentQuestion.answer || 0, currentQuestion.options || [0, 0, 0]);
    score += points;

    if (option === currentQuestion.answer) {
      correctSound.play().catch(() => {});
      correctCount++;
      confetti({ particleCount: 30, spread: 50, origin: { y: 0.6 } });
    } else {
      wrongSound.play().catch(() => {});
      wrongCount++;
    }

    feedbackTimer = FEEDBACK_DURATION; // Set to 4 seconds worth of frames
    imageZoom = 0;
    drawGame(); // Redraw immediately to show feedback

    setTimeout(() => {
      if (!isGameActive) return;
      if (wrongCount >= 3) {
        endGame("ძალიან ბევრი არასწორი პასუხი!");
      } else if (currentRound + 1 < totalRounds) {
        currentRound++;
        selectedAnswer = null;
        feedbackTimer = 0;
        imageZoom = 0;
        drawGame();
      } else {
        endGame();
      }
    }, 4000); // Wait 4 seconds (4000ms) before moving to next question
  }

  // ... (handleNextSlide, handleBackSlide, event listeners remain unchanged)

  preloadImages();
  resizeCanvas();
</script>
